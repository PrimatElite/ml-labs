# ml-labs

# Постановка задач

- [Intelligent Placer](https://docs.google.com/document/d/1o0lawEvLgmh9VrA5fUlOHFvo5JKxR4NThCFobmrKz60/edit#)
- [Intelligen Checker](https://docs.google.com/document/d/1Tmn7BLnHXiAsdCpB_GQVDqUx3AoGEdfOoTyn3Eg3P7A/edit#)

# Данные

[Ccылка на данные](https://drive.google.com/drive/folders/1B45ROu8KbjR2S3Wy8mYdcSyMI5RmO-Rr?usp=sharing)

# Правила работы с репозиторием

## Новые фичи и фиксы багов

Все задачи фиксируются на доске проекта Roadmap в этом репозитории. Затем к каждой задаче открывается issue, которое ассайнится на определенного контрибутора.

## Issues workflow

1) Создание нового issue из задачи.
2) Ассайн на конкретного контрибутора (за каждый issue ответственнен 1 человек, но работать над ним можно совместно)
3) Когда issue поступает в работу, оно должно быть перемещено в колонку `In progress` на доске проекта.
4) Под каждое issue создается отдельная ветка, ветка называется так: `<issue_id-short_desc>`

   Например, `2-placer_architecture`

5) Все коммиты в этой ветке должны начинаться с `#<issue_id>`.
6) Все issue-ветки сливаются в ветку `develop` через пулл реквесты.
7) Описания пулл реквестов должны иметь вид `<keyword> #<issue_id>`
где доступные ключевые слова представлены следующим списком

   * close
   * closes
   * closed
   * fix
   * fixes
   * fixed
   * resolve
   * resolves
   * resolved

8) В конце каждого майлстоуна делается пулл реквест `develop -> main`

# Ограничения на входные данные

## Конфиг для чекера

> Этот конфиг команда разработчик плейсера передает на вход чужому(и своему тоже) чекеру.
> По этому конфигу чекер понимает, в каких ограничениях тестируемый плейсер должен работать корректно, 
> и генерирует картинки с артефактами в соответствии с заданными диапазонами для каждого артефакта.

Для полного ознакомления с форматом ограничений рекоммендуется ознакомиться со схемой `restrictions_schema.json`

### Как настроить свой чекер для работы с конфигом

1. В корень проекта нужно положить файлы `restrictions_schema.json`, `default_config.yaml`
2. В `requirements.txt` необходимо указать `PyYaml`, `jsonschema`
3. Для работы с конфигами рекоммендуется использовать функции из модуля `src.util` (реализованы в файле `src/util/__init.py`)
   В коде чекера для того чтобы загрузить пользовательский конфиг, который вам передают, нужно использовать функцию
   `get_config`. Просто передайте ей путь до пользовательского конфига, она загрузит дефолтный конфиг, пользовательский
   конфиг, провалидирует их и выдаст полный пригодный для использования далее в коде словарь с ограничениями.
4. Чекеру требуется передать при старте путь до этого файла, например как параметр командной строки или как переменную
   окружения, или каким-либо иным образом.

### Пример указания ограничений в формате yaml 

```yaml
restrictions:
  - name: noise
    value:
      - 0.5
      - 4
  - name: rotation
    value: 
       - 0
       - 180
```

Если какие-то из ограничений не указаны - то соответствующие ограничения будут браться из дефолтного конфига `default_config.yaml`

### Артефакты, которые можно указывать в конфиге

| №    | Название                     | Размерность                       | Описание                                                     |
| ---- | ---------------------------- | --------------------------------- | ------------------------------------------------------------ |
| 1    | noise                        | (параметр сигма)                  | Зашумленность - дополнительные артефакты на изображении (возникают за счет дождя, либо дефектов матрицы). Генерируем случайную двумерную картинку распределением Гаусса. Параметр sigma. Задается диапазон возможных значений. (пример есть в чате 10 занятия) |
| 2    | blur                         | (параметр сигма)                  | Размытость - сглаженные куски изображения (возникают за счет движения камеры). Сворачиваем изображение с фильтром Гаусса 20x20. |
| 3    | shooting_height              | сантиметры                        | высота съемки                                                |
| 4    | shooting_angle               | градусы                           | Угол съемки (насколько камера наклонена)                     |
| 5    | camera_shift                 | расстояние в пикселях (евклидово) | Сдвиг центра съемки вбок от медианы от всех координат объектов на изображении |
| 6    | resolution                   | мегапиксели                       | Разрешение фотографии (произведение ширины на высоту)        |
| 7    | aspect_ratio                 | отношение ширины к высоте         | Отношение сторон фотографии                                  |
| 8    | rotation                     | градусы                           | Повороты объектов относительно оси Z (объект остается в том же ракурсе) |
| 9    | min_dist_between_obj         | миллиметры                        | Минимальное расстояние между объектами (Если объекты друг на друга накладываются: минимальное расстояние меньше 0) |
| 10   | min_dist_between_obj_polygon | миллиметры                        | Минимальное расстояние между объектами и многоугольником (Если объекты накладываются на многоугольник: минимальное расстояние меньше 0) |
| 11   | max_dist_between_obj_center  | миллиметры                        | Расстояние от “центра объектов/фотографии” до дальних объектов |
| 12   | polygon_vertex_num           | штуки                             | Число вершин многоугольника                                  |
| 13   | polygon_angle                | градусы                           | Углы многоугольника (диапазон в градусах, в который они должны попадать) |
| 14   | obj_num                      | штуки                             | Число объектов на фото                                       |
| 15   | line_width                   | миллиметры                        | Толщина линии многоугольника                                 |
| 16   | area_ratio                   | отношение                         | Отношение площади многоугольника к площади A4 (в естественной плоскости) |
| 17   | same_obj_num                 | штуки                             | Число одинаковых объектов на фото                            |
| 18   | back_shadows                 | миллиметры (максимальный диаметр) | Тени окружения, падающие на сцену                            |
| 19   | back_diff_obj                |                                   | Отличие фона от объектов (насколько сильно фон должен отличаться от объектов) |
| 20   | obj_shadows                  | миллиметры (максимальный диаметр) | Тени самих объектов                                          |

## Полный список рассматриваемых ограничений

### Фотометрические 

| Чекер                                                        | Плейсер                                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| снято перпендикулярно листу бумаги (угол зрения камеры в небольшом отклонении от вектора (0, 0, -1) через косинусы можно считать например) | диапазон для угла наклона камеры от прямой, перпендикулярной листу бумаги |
| естественный свет/верхний отраженный свет, рассеянное освещение | [зашумленность](https://stackoverflow.com/questions/58924276/detecting-noise-frames) |
| снятно на фоне чистого белого листа формата а4               | предметы не должны перекрывать лист с многоугольником        |
| лист а4 должен быть целиком виден на фото                    | основной фон должен быть однороден по цвету                  |
| высота съемки                                                | [размытость](https://stackoverflow.com/questions/7765810/is-there-a-way-to-detect-if-an-image-is-blurry/7767755#7767755) |
| разрешение фото (ширина, высота, отношение сторон)           | разрешение фото (ширина, высота, отношение сторон)           |
| [зашумленность](https://stackoverflow.com/questions/58924276/detecting-noise-frames) | высота съемки                                                |
| [размытость](https://stackoverflow.com/questions/7765810/is-there-a-way-to-detect-if-an-image-is-blurry/7767755#7767755) | без вспышки                                                  |
| без вспышки                                                  |                                                              |
| не должно быть ярко выраженных теней на листе бумаги         |                                                              |
| основной фон должен быть однороден по цвету                  |                                                              |
| на фотографиях лист должен занимать определённую площадь     |                                                              |

### Размещение объектов на фото
- ограничение на минимум/максимум линейного размера объектов
 - объекты должны распологаться на расстоянии друг от друга а также от края листа (диапазон допустимого расстояния)
 - объекты могут быть повернуты под любым углом относительно оси Z (перпендикулярна плоскости листа) относительно своего "начального положения"

### Ограничения на многоугольник
 - нарисован маркером черного цвета, толщина линии - (диапазон в мм)
 - не более N вершин
 - выпуклый (задаем допустимый диапазон для каждого из углов)
 - отношение площади многоугольника к площади a4 в фиксированном диапазоне
 - допустимо задание в виде списка координат вершин в осях XY (в плоскости листа a4), Цена деления сетки, на которой задан многоугольник - 1 мм
 - с случае задания при помощи маркера, координаты вершин вычисляются по внутреннему контуру границы

### Число объектов на фото
 - на фото может присутствовать от 1 до N объектов
 - все объекты на фото должны принадлежать к разным классам
